name: Build and Push Docker Image to ECR
description: Build a Docker image and push it to Amazon ECR.
author: "Anil Raj Rimal"

inputs:
  AWS_ROLE_ARN:
    required: true
    description: "IAM Role ARN to assume via GitHub OIDC"
  AWS_REGION:
    required: true
    description: "AWS region"
  BRANCH_NAME:
    required: true
    description: "Branch executing workflow"
  ECR_REPOSITORY:
    required: true
    description: "Amazon ECR repository name"
  DOCKERFILE_PATH:
    required: false
    default: './docker/Dockerfile'
    description: "Path to the Dockerfile for building the image"
  BUILD_CONTEXT:
    required: false
    default: '.'
    description: "The context for Docker build (default is the current directory)"
  PIP_MODULES_FILE:
    required: false
    default: './dependencies/requirements_gis.txt'
    description: "Path to the pip modules requirements file"
  APT_MODULES_FILE:
    required: false
    default: './dependencies/apt_requirements_gis.txt'
    description: "Path to the apt dependencies requirements file"
  IMAGE_TAG:
    required: false
    description: "Docker Image tag while pushing to ECR, default will be BRANCH NAME"

runs:
  using: 'composite'
  steps:
  - name: Checkout Code
    uses: actions/checkout@v5
    with:
      ref: ${{ inputs.BRANCH_NAME }}

  - name: Copy Dependency Files
    shell: bash
    run: |
      cp "${{ inputs.APT_MODULES_FILE }}" apt_requirements.txt
      cp "${{ inputs.PIP_MODULES_FILE }}" requirements.txt

  - name: Configure AWS Credentials (OIDC)
    uses: aws-actions/configure-aws-credentials@v5
    with:
      role-to-assume: ${{ inputs.AWS_ROLE_ARN }}
      aws-region: ${{ inputs.AWS_REGION }}

  - name: Login to Amazon ECR
    id: login-ecr
    uses: aws-actions/amazon-ecr-login@v2

  - name: Set IMAGE_TAG
    shell: bash
    run: |
      IMAGE_TAG="${{ inputs.IMAGE_TAG }}"
      if [[ -z "$IMAGE_TAG" ]]; then
        IMAGE_TAG="${{ inputs.BRANCH_NAME }}"
      fi
      echo "Using IMAGE_TAG: $IMAGE_TAG"
      echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
      echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> "$GITHUB_ENV"

  - name: Build Docker Image
    shell: bash
    run: |
      docker build -f "${{ inputs.DOCKERFILE_PATH }}" \
        -t "$ECR_REGISTRY/${{ inputs.ECR_REPOSITORY }}:$IMAGE_TAG" \
        "${{ inputs.BUILD_CONTEXT }}"

  - name: Push Docker Image to ECR
    shell: bash
    run: |
      docker push "$ECR_REGISTRY/${{ inputs.ECR_REPOSITORY }}:$IMAGE_TAG"

branding:
  icon: 'anchor'
  color: 'blue'
